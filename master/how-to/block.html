
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Writing a Block &#8212; PandABlocks-FPGA 0.1.dev2631+g00cd9e0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=d89ab3cc"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'how-to/block';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.2';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://shihab-dls.github.io/PandABlocks-FPGA/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'master';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="icon" href="../_static/PandA-logo.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Running the tests" href="testing.html" />
    <link rel="prev" title="Assembling Blocks into an App" href="app.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/PandA-logo-for-black-background.svg" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../_static/PandA-logo-for-black-background.svg" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">PandABlocks-FPGA</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../how-to.html">
                        How-to Guides
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference.html">
                        Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../blocks.html">
                        Available Blocks
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/shihab-dls/PandABlocks-FPGA" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/PandABlocks-FPGA" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-cube fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../how-to.html">
                        How-to Guides
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference.html">
                        Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../blocks.html">
                        Available Blocks
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/shihab-dls/PandABlocks-FPGA" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/PandABlocks-FPGA" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-cube fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-3"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-3"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-3"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-3">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="app.html">Assembling Blocks into an App</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Writing a Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Running the tests</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../how-to.html" class="nav-link">How-to Guides</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Writing a Block</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="writing-a-block">
<span id="block-reference"></span><h1>Writing a Block<a class="headerlink" href="#writing-a-block" title="Link to this heading">#</a></h1>
<p>If you have checked the list of <a class="reference internal" href="../blocks.html#blocks-doc"><span class="std std-ref">Available Blocks</span></a> and need a feature that is not
there you can extend an existing <a class="reference internal" href="../reference/glossary.html#block"><span class="std std-ref">Block</span></a> or create a new one. If the feature
fits with the behaviour of an existing Block and can be added without breaking
backwards compatibility it is preferable to add it there. If there is a new
type of behaviour it may be better to make a new one.</p>
<p>This page lists all of the framework features that are involved in making a
Block, finding a <a class="reference internal" href="../reference/glossary.html#module"><span class="std std-ref">Module</span></a> for it, defining the interface, writing the
simulation, writing the timing tests, documenting the behaviour, and finally
writing the logic.</p>
<section id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Link to this heading">#</a></h2>
<p>An overview of the build process is shown in this diagram, the stages and
terminology are defined below:</p>
<img alt="../_images/build_arch.png" src="../_images/build_arch.png" />
</section>
<section id="modules">
<h2>Modules<a class="headerlink" href="#modules" title="Link to this heading">#</a></h2>
<p>Modules are subdirectories in <code class="docutils literal notranslate"><span class="pre">modules/</span></code> that contain Block definitions. If
you are writing a soft Block then you will typically create a new Module for it.
If you are writing a Block with hardware connections it will live in a Module
for that hardware (e.g. for the FMC card, or for that <a class="reference internal" href="../reference/glossary.html#target-platform"><span class="std std-ref">Target Platform</span></a>).</p>
<p>To create a new module, simply create a new directory in <code class="docutils literal notranslate"><span class="pre">modules/</span></code></p>
</section>
<section id="block-ini">
<span id="block-ini-reference"></span><h2>Block ini<a class="headerlink" href="#block-ini" title="Link to this heading">#</a></h2>
<p>The first thing that should be defined when creating a new Block is the
interface to the rest of the framework. This consists of an ini file that
contains all the information that the framework needs to integrate some VHDL
logic into the system. It lives in the Module directory and has the extension
<code class="docutils literal notranslate"><span class="pre">.block.ini</span></code>. It consists of a top level section with information
about the Block, then a section for every <a class="reference internal" href="../reference/glossary.html#field"><span class="std std-ref">Field</span></a> in the Block.</p>
<section id="the-section">
<h3>The [.] section<a class="headerlink" href="#the-section" title="Link to this heading">#</a></h3>
<p>The first entry to the ini file describes the block as a whole. It looks like
this:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[.]</span>
<span class="na">description</span><span class="o">:</span><span class="w"> </span><span class="s">Short description of the Block</span>
<span class="na">entity</span><span class="o">:</span><span class="w"> </span><span class="s">vhdl_entity</span>
<span class="na">type</span><span class="o">:</span><span class="w"> </span><span class="s">dma or sfp or fmc</span>
<span class="na">constraints</span><span class="o">:</span>
<span class="na">ip</span><span class="o">:</span>
<span class="na">otherconst</span><span class="o">:</span>
<span class="na">extension</span><span class="o">:</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">description</span></code> should be a short (a few words) description that will be
visible as a Block label to users of the <a class="reference internal" href="../reference/glossary.html#pandablocks-device"><span class="std std-ref">PandABlocks Device</span></a> when it runs.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">entity</span></code> should be the name of the VHDL entity that will be created to
hold the logic. It is typically the lowercase version of the Block name.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">type</span></code> field will identify if the block is an SFP, FMC or DMA. These are
special cases and need to be handled differently. This field is automatically
set to soft for soft blocks or carrier for carrier blocks.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">constraints</span></code> is used to identify the location of any xdc constraints
files, relative to the module’s directory.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ip</span></code> field holds the name of any ip blocks used in the module’s vhdl code.</p>
<p><code class="docutils literal notranslate"><span class="pre">otherconst</span></code> is used to locate a tcl script if the block needs any further
configuration.</p>
<p>If the <code class="docutils literal notranslate"><span class="pre">extension</span></code> field is present then the <code class="docutils literal notranslate"><span class="pre">extensions</span></code> directory in the
module must exist and contain a python server extension file.</p>
</section>
<section id="field-sections">
<h3>[FIELD] sections<a class="headerlink" href="#field-sections" title="Link to this heading">#</a></h3>
<p>All other sections specify the Field that will be present in the Block. They
look like this:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[MYFIELD]</span>
<span class="na">type</span><span class="o">:</span><span class="w"> </span><span class="s">type subtype options</span>
<span class="na">description</span><span class="o">:</span><span class="w"> </span><span class="s">Short description of the Field</span>
<span class="na">extension</span><span class="o">:</span><span class="w"> </span><span class="s">extension-parameter</span>
<span class="na">wstb</span><span class="o">:</span>
</pre></div>
</div>
<p>The section name is used to determine the name of the Field in the resulting
Block. It should be made of upper case letters, numbers and underscores.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">type</span></code> value gives information about the <a class="reference external" href=":ref:`FieldType&lt;server:fields&gt;`">type</a> which specifies the
purpose and connections of the Field to the system. It is passed straight
through to the field specific line in the config file for the TCP server so
should be written according to <a class="reference external" href=":ref:`FieldType&lt;server:fields&gt;`">type</a> documentation. Subsequent indented lines
in the config file are supplied according to the <code class="docutils literal notranslate"><span class="pre">type</span></code> value and are
documented in <a class="reference internal" href="#extra-field-keys"><span class="std std-ref">Extra Field Keys</span></a>.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">type</span></code> is set as <code class="docutils literal notranslate"><span class="pre">extension_write</span></code> or <code class="docutils literal notranslate"><span class="pre">extension_read</span></code> the block is
a hidden register. It has a hardware register but does not generate block
names.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">description</span></code> value gives a short (single sentence) description about
what the Field does, visible as a tooltip to users.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">extension</span></code> is specified then this field is configured as an extension
field.  If the <code class="docutils literal notranslate"><span class="pre">extension_read</span></code> or <code class="docutils literal notranslate"><span class="pre">extension_write</span></code> fields are also
specified then this field does not generate its own hardware register but uses
the specified registers. If fields use extensions an [extension].py needs to
be created.</p>
<p>If a signal uses a write strobe <code class="docutils literal notranslate"><span class="pre">wstb</span></code> should be set to True.</p>
</section>
<section id="extra-field-keys">
<span id="id1"></span><h3>Extra Field Keys<a class="headerlink" href="#extra-field-keys" title="Link to this heading">#</a></h3>
<p>Some field types accept extra numeric keys in the Field section to allow extra
information to be passed to the TCP server via its config file.</p>
<p>Enum fields would contain numeric keys to translate specific numbers into
user readable strings. Strings should be lowercase letters and numbers with
underscores and no spaces. A typical field might look like this:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[ENUM_FIELD]</span>
<span class="na">type</span><span class="o">:</span><span class="w"> </span><span class="s">param enum</span><span class="w">  </span><span class="c1"># or read enum or write enum</span>
<span class="na">description</span><span class="o">:</span><span class="w"> </span><span class="s">Short description of the Field</span>
<span class="na">0</span><span class="o">:</span><span class="w"> </span><span class="s">first_value</span>
<span class="na">1</span><span class="o">:</span><span class="w"> </span><span class="s">next_value</span>
<span class="na">2</span><span class="o">:</span><span class="w"> </span><span class="s">another_value</span>
<span class="na">8</span><span class="o">:</span><span class="w"> </span><span class="s">gappy_value</span>
</pre></div>
</div>
<p>Tables will be defined here too</p>
</section>
</section>
<section id="block-simulation">
<span id="block-simulation-reference"></span><h2>Block Simulation<a class="headerlink" href="#block-simulation" title="Link to this heading">#</a></h2>
<p>The Block simulation framework allows the behaviour to be specified in Python
and timing tests to be written against it without writing any VHDL. This is
beneficial as it allows the behaviour of the Block to be tied down and
documented while the logic is relatively easy to change. It also gives an
accurate simulation of the Block that can be used to simulate an entire
<a class="reference internal" href="../reference/glossary.html#pandablocks-device"><span class="std std-ref">PandABlocks Device</span></a>.</p>
<p>The first step in making a Block Simulation is to define the imports:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">common.python.simulations</span> <span class="kn">import</span> <span class="n">BlockSimulation</span><span class="p">,</span> <span class="n">properties_from_ini</span><span class="p">,</span> \
    <span class="n">TYPE_CHECKING</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">typing</span></code> imports allow IDEs like PyCharm to infer the types of the
variables, increasing the chance of finding bugs at edit time.</p>
<p>The BlockSimulation is a baseclass that our simulation should inherit from:</p>
<dl class="py class">
<dt class="sig sig-object py" id="common.python.simulations.BlockSimulation">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">common.python.simulations.</span></span><span class="sig-name descname"><span class="pre">BlockSimulation</span></span><a class="reference internal" href="../_modules/common/python/simulations.html#BlockSimulation"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#common.python.simulations.BlockSimulation" title="Link to this definition">#</a></dt>
<dd><dl class="py attribute">
<dt class="sig sig-object py" id="common.python.simulations.BlockSimulation.changes">
<span class="sig-name descname"><span class="pre">changes</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">None</span></em><a class="headerlink" href="#common.python.simulations.BlockSimulation.changes" title="Link to this definition">#</a></dt>
<dd><p>This will be dictionary with changes pushed by any properties created
with properties_from_ini()</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="common.python.simulations.BlockSimulation.bits_to_int">
<em class="property"><span class="pre">classmethod</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">bits_to_int</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">bits</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/common/python/simulations.html#BlockSimulation.bits_to_int"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#common.python.simulations.BlockSimulation.bits_to_int" title="Link to this definition">#</a></dt>
<dd><p>Convert 32 element bit array into an int number</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="common.python.simulations.BlockSimulation.on_changes">
<span class="sig-name descname"><span class="pre">on_changes</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">ts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">changes</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/common/python/simulations.html#BlockSimulation.on_changes"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#common.python.simulations.BlockSimulation.on_changes" title="Link to this definition">#</a></dt>
<dd><p>Handle field changes at a particular timestamp</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>ts</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a>) – The timestamp the changes occurred at</p></li>
<li><p><strong>changes</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.12)"><em>dict</em></a>) – Field names that changed with their integer value</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>If the Block needs to be called back at a particular ts then return
that int, otherwise return None and it will be called when a field
next changes</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<p>Next we read the block ini file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">NAMES</span><span class="p">,</span> <span class="n">PROPERTIES</span> <span class="o">=</span> <span class="n">properties_from_ini</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span> <span class="s2">&quot;myblock.block.ini&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This generates two objects:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NAMES</span></code>: A <a class="reference external" href="https://docs.python.org/3/library/collections.html#collections.namedtuple" title="(in Python v3.12)"><code class="xref any docutils literal notranslate"><span class="pre">collections.namedtuple</span></code></a> with a string attribute for every field,
for comparing field names with.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PROPERTIES</span></code>: A <a class="reference external" href="https://docs.python.org/3/library/functions.html#property" title="(in Python v3.12)"><code class="xref any docutils literal notranslate"><span class="pre">property</span></code></a> for each Field of the Block that can be attached
to the <a class="reference internal" href="#common.python.simulations.BlockSimulation" title="common.python.simulations.BlockSimulation"><code class="xref any py py-class docutils literal notranslate"><span class="pre">BlockSimulation</span></code></a> class</p></li>
</ul>
<p>Now we are ready to create our simulation class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBlockSimulation</span><span class="p">(</span><span class="n">BlockSimulation</span><span class="p">):</span>
    <span class="n">INP</span><span class="p">,</span> <span class="n">ANOTHER_FIELD</span><span class="p">,</span> <span class="n">OUT</span> <span class="o">=</span> <span class="n">PROPERTIES</span>

    <span class="k">def</span> <span class="nf">on_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">changes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle field changes at a particular timestamp</span>

<span class="sd">        Args:</span>
<span class="sd">            ts (int): The timestamp the changes occurred at</span>
<span class="sd">            changes (Dict[str, int]): Fields that changed with their value</span>

<span class="sd">        Returns:</span>
<span class="sd">             If the Block needs to be called back at a particular ts then return</span>
<span class="sd">             that int, otherwise return None and it will be called when a field</span>
<span class="sd">             next changes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set attributes</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyBlockSimulation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_changes</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">changes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">NAMES</span><span class="o">.</span><span class="n">INP</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
            <span class="c1"># If our input changed then set our output high</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OUT</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># Need to be called back next clock tick to set it back</span>
            <span class="k">return</span> <span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The next clock tick set it back low</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OUT</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>This is a very simple Block, when <code class="docutils literal notranslate"><span class="pre">INP</span></code> changes, it outputs a 1 clock tick
pulse on <code class="docutils literal notranslate"><span class="pre">OUT</span></code>. It checks the changes dict to see if <code class="docutils literal notranslate"><span class="pre">INP</span></code> is in it, and
if it is then sets <code class="docutils literal notranslate"><span class="pre">OUT</span></code> to 1. The framework only calls <code class="docutils literal notranslate"><span class="pre">on_changes()</span></code>
when there are changes unless informed when the Block needs to be called next.
In this case we need to be called back the next clock tick to set <code class="docutils literal notranslate"><span class="pre">OUT</span></code> back
to zero, so we do this by returning <code class="docutils literal notranslate"><span class="pre">ts</span> <span class="pre">+</span> <span class="pre">1</span></code>. When we are called back next
clock tick then there is nothing in the changes dict, so <code class="docutils literal notranslate"><span class="pre">OUT</span></code> is set back
to 0 and return None so the framework won’t call us back until something
changes.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you need to use a field name in code, use an attribute of <code class="docutils literal notranslate"><span class="pre">NAMES</span></code>. This
avoids mistakes due to typos like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s2">&quot;INPP&quot;</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
    <span class="n">code_that_will_never_execute</span>
</pre></div>
</div>
<p>While if we use <code class="docutils literal notranslate"><span class="pre">NAMES</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">NAMES</span><span class="o">.</span><span class="n">INPP</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>  <span class="c1"># Fails with AttributeError</span>
</pre></div>
</div>
</div>
</section>
<section id="timing-ini">
<h2>Timing ini<a class="headerlink" href="#timing-ini" title="Link to this heading">#</a></h2>
<p>The purpose of the .timing.ini file is to provide expected data for comparison
in the testing of the modules. Data should be calculated as to how and when the
module will behave with a range of inputs.</p>
<section id="id2">
<h3>The [.] section<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<p>The first entry to the ini file describes the timing tests as a whole. It looks
like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">.</span><span class="p">]</span>
<span class="n">description</span><span class="p">:</span> <span class="n">Timing</span> <span class="n">tests</span> <span class="k">for</span> <span class="n">Block</span>
<span class="n">scope</span><span class="p">:</span> <span class="n">block</span><span class="o">.</span><span class="n">ini</span> <span class="n">file</span>
</pre></div>
</div>
</section>
<section id="test-sections">
<h3>[TEST] sections<a class="headerlink" href="#test-sections" title="Link to this heading">#</a></h3>
<p>The other sections will display the tests inputs and outputs. It looks like
this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">NAME_OF_TEST</span><span class="p">]</span>
<span class="mi">1</span><span class="p">:</span>  <span class="n">inputA</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inputB</span><span class="o">=</span><span class="mi">2</span>          <span class="o">-&gt;</span> <span class="n">output</span><span class="o">=</span><span class="mi">3</span>
<span class="mi">5</span><span class="p">:</span>  <span class="n">inputC</span><span class="o">=</span><span class="mi">4</span>                    <span class="o">-&gt;</span> <span class="n">output</span><span class="o">=</span><span class="mi">7</span>
<span class="mi">6</span><span class="p">:</span>  <span class="n">inputD</span><span class="o">=-</span><span class="mi">10</span>                  <span class="o">-&gt;</span> <span class="n">output</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Error</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>The numbers at the left indicate the timestamp at which a change occurs,
followed by a colon. Any assignments before the -&gt; symbol indicate a change in
an input and assignments after the -&gt; symbol indicate a change in an output.</p>
</section>
</section>
<section id="target-ini">
<h2>Target ini<a class="headerlink" href="#target-ini" title="Link to this heading">#</a></h2>
<p>A target.ini is written for the blocks which are specific to the target. This
ini file declares the blocks and their number similar to the app.ini file.</p>
<section id="id3">
<h3>The [.] section<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<p>The first entry to the ini file defines information for the SFP sites for the
target:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">.</span><span class="p">]</span>
<span class="n">sfp_sites</span><span class="p">:</span>
<span class="n">sfp_constraints</span><span class="p">:</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">sfp_sites</span></code> type is the number of available SFP sites on the target, and
the <code class="docutils literal notranslate"><span class="pre">sfp_sites</span></code> type is the name of the constraints file for each SFP site,
located in the target/const directory.</p>
</section>
<section id="block-sections">
<h3>[BLOCK] sections<a class="headerlink" href="#block-sections" title="Link to this heading">#</a></h3>
<p>The block sections are handled in the same manner as those within the app.ini
file, however the type, unless overwritten in the block.ini files for these
blocks is set to carrier, rather than soft.</p>
</section>
</section>
<section id="writing-docs">
<h2>Writing docs<a class="headerlink" href="#writing-docs" title="Link to this heading">#</a></h2>
<p>Two RST directives, how to structure</p>
</section>
<section id="block-vhdl-entity">
<h2>Block VHDL entity<a class="headerlink" href="#block-vhdl-entity" title="Link to this heading">#</a></h2>
<p>How to structure the VHDL entity</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="app.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Assembling Blocks into an App</p>
      </div>
    </a>
    <a class="right-next"
       href="testing.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Running the tests</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#architecture">Architecture</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modules">Modules</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#block-ini">Block ini</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-section">The [.] section</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#field-sections">[FIELD] sections</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extra-field-keys">Extra Field Keys</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#block-simulation">Block Simulation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#common.python.simulations.BlockSimulation"><code class="docutils literal notranslate"><span class="pre">BlockSimulation</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#common.python.simulations.BlockSimulation.changes"><code class="docutils literal notranslate"><span class="pre">BlockSimulation.changes</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#common.python.simulations.BlockSimulation.bits_to_int"><code class="docutils literal notranslate"><span class="pre">BlockSimulation.bits_to_int()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#common.python.simulations.BlockSimulation.on_changes"><code class="docutils literal notranslate"><span class="pre">BlockSimulation.on_changes()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#timing-ini">Timing ini</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">The [.] section</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#test-sections">[TEST] sections</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#target-ini">Target ini</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">The [.] section</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#block-sections">[BLOCK] sections</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#writing-docs">Writing docs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#block-vhdl-entity">Block VHDL entity</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/shihab-dls/PandABlocks-FPGA/edit/master/docs/how-to/block.rst">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/how-to/block.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>